format_version: "10"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
meta:
  bitrise.io:
    stack: osx-xcode-13.3.x
project_type: other
app:
  envs:
  - BITRISE_PROJECT_PATH: ./your_project_name.xcodeproj
  - BITRISE_SCHEME: your_project_name
  - BITRISE_EXPORT_METHOD: ad-hoc
workflows:
  primary:
    steps:
    - git-clone:
        title: Checkout repository
    - script:
        title: Download Godot
        inputs:
        - content: |
            wget https://github.com/godotengine/godot/releases/download/3.5.3-stable/Godot_v3.5.3-stable_osx.universal.zip
            unzip Godot_v3.5.3-stable_osx.universal.zip -d godot
            sudo mv godot/Godot.app /Applications/Godot.app
            sudo ln -s /Applications/Godot.app/Contents/MacOS/Godot /usr/local/bin/godot
    - script:
        title: Download Godot Export Templates
        inputs:
        - content: |
            wget https://github.com/godotengine/godot/releases/download/3.5.3-stable/Godot_v3.5.3-stable_export_templates.tpz
            mkdir -p ~/Library/Application\ Support/Godot/templates/3.5.3.stable
            tar -xzf Godot_v3.5.3-stable_export_templates.tpz -C ~/Library/Application\ Support/Godot/templates/3.5.3.stable
    - script:
        title: Create build directory
        inputs:
        - content: mkdir -p build
    - script:
        title: Export iOS project
        inputs:
        - content: |
            godot --export "iOS" build/your_project_name.xcodeproj
        envs:
        - DISPLAY: :99.0
    - script:
        title: Set iOS Deployment Target
        inputs:
        - content: |
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 10.0;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/' build/your_project_name.xcodeproj/project.pbxproj
    - xcode-archive:
        title: Build iOS project
        inputs:
        - project_path: build/your_project_name.xcodeproj
        - scheme: your_project_name
        - export_method: ad-hoc
        - configuration: Release
        - archive_path: build/your_project_name.xcarchive
        - code_sign_identity: ""
        - team_id: ""
        - allow_provisioning_updates: false
    - script:
        title: Export IPA
        inputs:
        - content: |
            xcodebuild -exportArchive -archivePath build/your_project_name.xcarchive -exportPath build -exportOptionsPlist exportOptions.plist \
               CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
    - deploy-to-bitrise-io:
        title: Upload IPA
        inputs:
        - artifact_path: build/your_project_name.ipa
